# 基于多维度特征增强的恶意代码检测系统

## 项目概述

随着大数据时代的到来，恶意软件和网页后门等攻击手段对个人计算机及工业生产构成了巨大威胁。恶意软件不仅能窃取敏感信息、破坏系统正常运行，甚至可能控制整个网络设备。而传统基于签名和单一机器学习方法的检测手段，由于无法高效提取恶意代码多样化的特征，已难以应对新型恶意代码的不断演变。

本项目提出了一种**基于多维度特征增强的恶意代码检测系统**，利用深度学习技术，从多个角度对恶意代码进行检测，主要包括两大检测模块：
  
1. **Webshell（网页后门）检测模块**  
   该模块通过融合三种不同的特征维度来实现检测：
   - **内容特征捕捉层**：将代码文件的字符级数据转换为灰度图像，通过卷积神经网络（CNN）捕捉代码中的局部模式与特征。
   - **语义特征捕捉层**：采用预训练 BERT 模型对代码进行分词，并提取 CLS 标记所对应的全局语义特征，再通过全连接层实现分类。
   - **结构特征捕捉层**：利用 Tree-sitter 构建抽象语法树（AST），将函数节点名称转换为词向量（Word2Vec），并使用图卷积网络（GCN）捕捉代码的调用流程和结构信息。
   - **置信度融合层**：对上述三个模型输出的置信度进行阈值判断和串行逻辑判断，最终得出融合后的检测结果，从而有效提高检测的准确率和鲁棒性。

2. **恶意软件检测模块**  
   针对木马、蠕虫、挖矿软件等恶意软件，本模块提出了一种基于 API 调用序列的检测方法：
   - 将软件运行时所需的 API 函数、动态链接库、节数据等处理为文本序列。
   - 使用预训练的 RoBERTa 模型进行动态词嵌入，充分捕捉 API 序列中的语义关系。
   - 针对 API 调用序列过长的问题，提出基于聚焦文本词向量权重的序列压缩算法，有效降低数据噪声并聚焦重要特征。
   - 采用多维度特征加强的 TextCNN-Liner-Att-BiLSTM 模型，先后提取浅层（Liner）特征、局部依赖特征（TextCNN）和长期依赖特征（Att-BiLSTM），并将提取的多层次特征融合后通过全连接层进行分类检测。

关键词：恶意代码检测；多维度特征增强；API调用序列；词嵌入；权重序列压缩

---

## 项目目录结构

以下是项目主要目录结构说明（基于实际源码目录）：

```
项目根目录/
│
├── app.py                                 # Flask 主程序，负责启动Web服务
├── PE_Detect_FC.py                        # PE 文件（恶意软件）检测模型实现
├── Webshell_Detect_FC.py                  # Webshell（网页后门）检测模型实现
├── PE/                                    # PE 检测相关素材与源码
├── static/                                # 静态资源文件夹
│   ├── css/                               # 样式表（CSS）目录
│   ├── img/                               # 图片资源目录
│   ├── js/                                # JavaScript 文件目录
│   ├── __init__.py                        # 静态文件初始化文件
│   └── bootstrap-4.0.0/                   # Bootstrap 框架文件
├── templates/                             # HTML 模板文件夹
│   └── selfpage.html                      # 自定义网页模板
├── Webshell_detect_models/                # Webshell检测模型文件夹
│   ├── GCN/                               # GCN 相关文件夹（用于代码结构特征提取）
│   │   ├── build/                         # 模型构建相关文件
│   │   ├── __init__.py                    # GCN 模块初始化文件
│   │   ├── 81model.pth                    # 预训练 GCN 模型权重文件
│   │   ├── Network.py                     # GCN 模型网络结构定义
│   │   ├── word2vec.model                 # 预训练 Word2Vec 模型（用于节点词嵌入）
│   │   ├── .idea/                         # IDE 配置文件（例如 PyCharm）
│   │   └── __pycache__/                   # Python 字节码缓存
│   ├── ......                             # 若干模型参数
├── .idea/                                 # 项目级别 IDE 配置文件
└── __pycache__/                           # Python 字节码缓存文件夹
```

---

## 系统架构与模型设计

### 1. Webshell 检测模块

#### 1.1 模型结构设计
- **内容特征捕捉层**  
  1. 将代码文件中每个字符的 ASCII 码（范围 0-255）除以 256 后归一化为 [0, 1] 数值；  
  2. 将归一化后的数值排列生成灰度图像；  
  3. 对灰度图像进行尺寸调整（例如调整为 128×128），并输入卷积神经网络（CNN）进行局部模式和内容特征提取。

- **语义特征捕捉层**  
  1. 通过 BERT 模型对代码文件进行分词，转换为 BERT 可识别的输入格式；  
  2. 提取 BERT 最后一层隐藏状态中 CLS 标记对应的全局语义特征；  
  3. 通过连续全连接层对语义特征进行映射，并使用 softmax 获取分类置信度。

- **结构特征捕捉层**  
  1. 使用 Tree-sitter 构建代码的抽象语法树（AST），捕捉函数调用和控制流结构；  
  2. 将 AST 中每个函数节点的名称转换为词向量（利用 Word2Vec 模型）；  
  3. 构建图结构数据，将节点表示和函数调用关系输入图卷积网络（GCN），学习代码的结构信息；  
  4. 通过全连接层输出分类预测结果（采用 Sigmoid 激活函数）。

- **置信度融合层**  
  对三个模型（CNN、BERT、GCN）输出的置信度进行阈值判断（通常阈值设为 0.5），并利用串行逻辑规则进行融合决策，以达到更高的检测准确率和鲁棒性。

#### 1.2 模型优势  
- **综合特征融合**：通过同时捕捉内容、语义及结构特征，有效应对多变的 Webshell 攻击手段；  
- **鲁棒性高**：置信度融合策略减少误报和漏报；  
- **实验结果**：融合模型在测试数据集上取得了高于单一模型的检测准确率。

---

### 2. 恶意软件检测模块

#### 2.1 模型设计流程  
- **词嵌入层**  
  使用预训练的 RoBERTa 模型对 API 调用序列进行字符级嵌入，充分捕捉 API 序列的语义信息。

- **特征捕捉层**  
  结合浅层特征提取（Liner 层）、局部依赖特征提取（TextCNN）和长期依赖特征提取（Att-BiLSTM）：  
  - **TextCNN**：通过不同大小的卷积核捕捉文本中的局部特征；  
  - **Att-BiLSTM**：采用双向 LSTM 结合注意力机制，捕捉 API 调用序列中的长期依赖关系。

- **特征融合与分类**  
  将提取的深浅层特征融合后，输入全连接层进行降维和分类预测，最终输出一个介于 0 和 1 之间的值，表示该样本是否为恶意软件。

#### 2.2 模型优势  
- **序列压缩算法**：针对重复 API 调用导致序列过长的问题，提出序列压缩方法，有效减少噪声，突出关键特征；  
- **多维度特征融合**：综合利用浅层和深层特征，大幅提升了检测的准确率和鲁棒性；  
- **实验验证**：在与 FastText、TextCNN、Att-BiLSTM、BERT 等多种模型对比中，融合模型表现最佳。

---

## 实验与分析

### 3.1 实验数据集  
- **Webshell 检测数据集**：收集自 GitHub 的开源恶意后门代码和正常代码，总量约 1.6 万个样本，二分类任务中两类样本数量基本均衡。  
- **恶意软件检测数据集**：数据来源于 MALWAREbazaar，涵盖 AgentTesla、PureLogStealer、Privateloader、DCRAT、AsyncRAT、Netsupport、Worms、Coinminer、MassLogger、Formbook、Vidar、Mirai、CobaltStrike、Lesso 等多个家族，每个家族样本约 150 个；正常样本来源于 GitHub 开源项目及自行编译生成的 exe 文件。

### 3.2 实验环境与参数设置

#### Webshell 检测模型参数  
- **卷积神经网络 (CNN)**  
  - 特征图尺寸：128×128  
  - 卷积层：5 层，每层卷积核大小为 3×3  
  - 池化层：使用 2×2 的最大池化核，步长为 2  
  - 激活函数：LeakyReLU  
  - 输出层：Sigmoid 激活函数  
  - 优化器：Adam，学习率 0.0005  
  - 训练轮数：50  
- **BERT 模型**  
  - 模型：`bert-base-uncased`  
  - 特征提取：基于 BERT 最后一层 [CLS] 标记  
  - 分类器：两层全连接层（768→128，128→64），输出维度为 1  
  - 激活函数：LeakyReLU + Sigmoid  
- **GCN 模型**  
  - 节点词嵌入：使用 Word2Vec，输入维度为词向量维度，输出维度为 48  
  - 隐层维度：64  
  - 激活函数：LeakyReLU  
  - 输出层：Sigmoid  
  - 训练轮数：110

#### 恶意软件检测模型参数  
- **词嵌入**：使用 RoBERTa 模型进行动态词嵌入，词向量维度为 768  
- **TextCNN**  
  - 卷积核高度：2、3、4  
  - 卷积核数量：100  
- **Att-BiLSTM**  
  - 隐藏单元数量：128  
  - Dropout：0.5  
- **训练设置**：  
  - 批次大小：32  
  - 学习率：0.0005  
  - Epoch：30

### 3.3 模型指标分析

#### Webshell 检测
- **单一模型性能**：  
  - CNN 模型：准确率 95.47%，召回率 95.34%，F1 分数 95.39%  
  - BERT 模型：准确率 98.34%，召回率 98.04%，F1 分数 97.97%  
  - GCN 模型：正常文件识别准确率 99.61%  
- **融合模型性能**：  
  - 恶意代码识别准确率：99.55%  
  - 正常代码识别准确率：98.91%  
  融合模型充分利用了不同特征层面的优势，大幅降低了误报率和漏报率。

#### 恶意软件检测
- 与 FastText、TextCNN、Att-BiLSTM、BERT 等模型对比，TextCNN-Liner-Att-BiLSTM 混合模型在测试数据集上取得了最高准确率（约 94.31%），相比 BERT 模型提高了约 1.60%。

---

## 使用说明

### 环境配置

1. 安装 Python 3.10 或更高版本。
2. 安装所需依赖库：
   ```bash
   pip install -r requirements.txt
   ```
3. 配置 GPU 环境（若使用 GPU 训练，请确保 CUDA 环境配置正确）。

### 数据准备

- 将 Webshell 和恶意软件检测数据集分别放入项目相应目录（例如 `data/` 文件夹）。
- 确保模型文件（如 `81model.pth`、`word2vec.model`）位于 `Webshell_detect_models/GCN/` 目录下。

### 运行项目

- **启动 Web 服务**：运行 `app.py`，启动 Flask Web 服务器：
  ```bash
  python app.py
  ```
  访问 `http://localhost:5000` 查看 Webshell 和恶意软件检测结果。
  
![image](https://github.com/user-attachments/assets/32f7b76e-c953-4b26-b714-e435b4223dc6)
![image](https://github.com/user-attachments/assets/8df702b9-02e6-429e-b700-0cdca66b93b6)

- **单独测试各模型**：可通过命令行运行相应的脚本（如 `Webshell_Detect_FC.py`、`PE_Detect_FC.py`）进行模型单独测试。

---

## 贡献与交流

如果您对本项目有任何建议、疑问或改进意见，欢迎提交 Issue 或 Pull Request。我们非常欢迎社区的参与和反馈，共同推动恶意代码检测技术的发展。

---

## 许可证

本项目采用 [MIT 许可证](LICENSE) 进行开源，详细信息请参见 LICENSE 文件。

---

## 结语

本作品通过结合内容、语义和结构三维特征，构建了一个多维度特征增强的恶意代码检测系统，在 Webshell 和恶意软件检测上均取得了显著效果。未来，我们计划进一步探索更多特征融合技术，优化模型结构，并在更大规模的数据集上验证系统的泛化能力，为网络安全防护提供更加坚实的技术支持。
